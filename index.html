<html>
<head>
	<link rel="stylesheet" type="text/css" href="css/custom.css">
	<script type="text/javascript" src="js/swfobject-2.2.min.js"></script>
	<script type="text/javascript" src="js/dtjava.js"></script>
	<script type="text/javascript" src="js/evercookie.js"></script>
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<title>Hercule VS Evercookie</title>
</head>
<body>

<fieldset>
	<legend>Configuration</legend>
	<div>
		<form method="get">
			<div>
				<p><strong>Launch mode</strong></p>
				<select name="mode">
					<option value="refresh">Refresh (default)</option>
					<option value="regenerate">Regenerate</option>
				</select>
			</div>
			<div>
				<p><strong>Working storages</strong></p>
				<div class="toggle">
					<input type="checkbox" id="cookieToggle" name="cookie" value="true"/>
					<label for="cookieToggle">HTTP Cookie</label>
				</div>
				<div class="toggle">
					<input type="checkbox" id="localToggle" name="local" value="true"/>
					<label for="localToggle">LocalStorage</label>
				</div>
				<div class="toggle">
					<input type="checkbox" id="sessionToggle" name="session" value="true"/>
					<label for="sessionToggle">SessionStorage</label>
				</div>
				<div class="toggle">
					<input type="checkbox" id="windowToggle" name="window" value="true"/>
					<label for="windowToggle">Window name</label>
				</div>
				<div class="toggle">
					<input type="checkbox" id="dbToggle" name="db" value="true"/>
					<label for="dbToggle">Web SQL DB</label>
				</div>
				<div class="toggle">
					<input type="checkbox" id="idbToggle" name="idb" value="true"/>
					<label for="idbToggle">Indexed DB</label>
				</div>
				<div class="toggle">
					<input type="checkbox" id="cacheToggle" name="cache" value="true"/>
					<label for="cacheToggle">Web Cache</label>
				</div>

				<div class="toggle">
					<input type="checkbox" id="etagToggle" name="etag" value="true"/>
					<label for="etagToggle">Etags</label>
				</div>
				<div class="toggle">
					<input type="checkbox" id="pngToggle" name="png" value="true"/>
					<label for="pngToggle">PNG reading</label>
				</div>
        <div class="toggle">
					<input type="checkbox" id="hstsToggle" name="hsts" value="true"/>
					<label for="hstsToggle">HSTS</label>
				</div>
			</div>

			<div>
				<p><strong>Deprecated or scope limited storages</strong></p>
				<div class="toggle">
					<input type="checkbox" id="globalToggle" name="global" value="true"/>
					<label for="globalToggle">GlobalStorage</label>
				</div>
				<div class="toggle">
					<input type="checkbox" id="userToggle" name="user" value="true"/>
					<label for="userToggle">User Data</label>
				</div>
				<div class="toggle">
					<input type="checkbox" id="javaToggle" name="java" value="true"/>
					<label for="javaToggle">Java Applet</label>
				</div>
				<div class="toggle">
					<input type="checkbox" id="lsoToggle" name="lso" value="true"/>
					<label for="lsoToggle">Flash Cookie</label>
				</div>
				<div class="toggle">
					<input type="checkbox" id="slToggle" name="sl" value="true"/>
					<label for="slToggle">Silverlight</label>
				</div>
				<div class="toggle">
					<input type="checkbox" id="historyToggle" name="history" value="true"/>
					<label for="historyToggle">CSS History</label>
				</div>
			</div>

			<div>
				<p>The battle will soon begin ...</p>
				<input type="submit" value="FIGHT!"/>
			</div>
		</form>
	</div>
</fieldset>

<fieldset>
	<legend>Control panel</legend>
	<div>
		<label for="uid">User ID</label>
		<input type="text" name="uid" id="uid" value="123"/>
		<button onclick="generateZombieCookie()">GENERATE</button>
		<button onclick="regenerateZombieCookie()">REGENERATE</button>
	</div>
</fieldset>

<h2>uid = <span id="idtag" style="color: red">loading ...</span></h2>

<div id="hydra-heads">
	<div id="localData" class="hydra-head-loading">
		<input type="hidden" id="localDataState" value="loading"/>
		<div id="localDataValue" class="head-value">???</div>
		<div class="head-label">LocalStorage</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="sessionData" class="hydra-head-loading">
		<input type="hidden" id="sessionDataState" value="loading"/>
		<div id="sessionDataValue" class="head-value">???</div>
		<div class="head-label">SessionStorage</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="windowData" class="hydra-head-loading">
		<input type="hidden" id="windowDataState" value="loading"/>
		<div id="windowDataValue" class="head-value">???</div>
		<div class="head-label">Window name</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="dbData" class="hydra-head-loading">
		<input type="hidden" id="dbDataState" value="loading"/>
		<div id="dbDataValue" class="head-value">???</div>
		<div class="head-label">Web SQL DB</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="idbData" class="hydra-head-loading">
		<input type="hidden" id="idbDataState" value="loading"/>
		<div id="idbDataValue" class="head-value">???</div>
		<div class="head-label">Indexed DB</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="cookieData" class="hydra-head-loading">
		<input type="hidden" id="cookieDataState" value="loading"/>
		<div id="cookieDataValue" class="head-value">???</div>
		<div class="head-label">HTTP Cookie</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="cacheData" class="hydra-head-loading">
		<input type="hidden" id="cacheDataState" value="loading"/>
		<div id="cacheDataValue" class="head-value">???</div>
		<div class="head-label">Web Cache</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="etagData" class="hydra-head-loading">
		<input type="hidden" id="etagDataState" value="loading"/>
		<div id="etagDataValue" class="head-value">???</div>
		<div class="head-label">Etags</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="pngData" class="hydra-head-loading">
		<input type="hidden" id="pngDataState" value="loading"/>
		<div id="pngDataValue" class="head-value">???</div>
		<div class="head-label">PNG reading</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="historyData" class="hydra-head-loading">
		<input type="hidden" id="historyDataState" value="loading"/>
		<div id="historyDataValue" class="head-value">???</div>
		<div class="head-label">CSS History</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="javaData" class="hydra-head-loading">
		<input type="hidden" id="javaDataState" value="loading"/>
		<div id="javaDataValue" class="head-value">???</div>
		<div class="head-label">Java Applet</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="lsoData" class="hydra-head-loading">
		<input type="hidden" id="lsoDataState" value="loading"/>
		<div id="lsoDataValue" class="head-value">???</div>
		<div class="head-label">Flash Cookie</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="hstsData" class="hydra-head-loading">
		<input type="hidden" id="hstsDataState" value="loading"/>
		<div id="hstsDataValue" class="head-value">???</div>
		<div class="head-label">HSTS</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="slData" class="hydra-head-loading">
		<input type="hidden" id="slDataState" value="loading"/>
		<div id="slDataValue" class="head-value">???</div>
		<div class="head-label">Silverlight</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="userData" class="hydra-head-loading">
		<input type="hidden" id="userDataState" value="loading"/>
		<div id="userDataValue" class="head-value">???</div>
		<div class="head-label">User Data</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
	<div id="globalData" class="hydra-head-loading">
		<input type="hidden" id="globalDataState" value="loading"/>
		<div id="globalDataValue" class="head-value">???</div>
		<div class="head-label">GlobalStorage</div>
		<div class="head-illustration"></div>
		<div class="head-background"></div>
	</div>
</div>

<script>
	// Name of my tracking field
	let zombieCookieName = 'uid';

	// Interval pointer for zombie cookie autorefresh
	let refreshInterval;

	// Get head configuration from URL
	const urlParams = new URLSearchParams(window.location.search);
	function toggleValueFromUrl(toggleName) {
		return !!urlParams.get(toggleName);
	}

  const toggleNames = [
		'cookie',
		'session',
		'local',
		'global',
		'window',
		'user',
		'db',
		'idb',
		'png',
		'etag',
		'cache',
		'history',
		'java',
		'lso',
		'hsts',
		'sl'
	];
  for(const toggleName of toggleNames) {
		const toggleValue = toggleValueFromUrl(toggleName);
		if (!toggleValue) {
			document.getElementById(toggleName + 'Data').className = 'hydra-head-hidden';
			document.getElementById(toggleName + 'DataState').value = 'hidden';
		} else {
			document.getElementById(toggleName + 'Toggle').checked = true;
		}
	}

  // Instanciating Zombie Cookie
	let zombieCookie = new evercookie({
		domain: 'localhost',
		tests: 1,
		cookie: toggleValueFromUrl('cookie'),
		localStorage: toggleValueFromUrl('local'),
		sessionStorage: toggleValueFromUrl('session'),
		globalStorage: toggleValueFromUrl('global'),
		userData: toggleValueFromUrl('user'),
		windowName: toggleValueFromUrl('window'),
		db: toggleValueFromUrl('db'),
		idb: toggleValueFromUrl('idb'),
		png: toggleValueFromUrl('png'),
		etag: toggleValueFromUrl('etag'),
		cache: toggleValueFromUrl('cache'),
		history: toggleValueFromUrl('history'),
		java: toggleValueFromUrl('java'),
		lso: toggleValueFromUrl('lso'),
		hsts: toggleValueFromUrl('hsts'),
		hsts_domains: [
			'http://sub1.localhost/php/hsts_cookie.php',
			'http://sub2.localhost/php/hsts_cookie.php',
			'http://sub3.localhost/php/hsts_cookie.php',
			'http://sub4.localhost/php/hsts_cookie.php',
			'http://sub5.localhost/php/hsts_cookie.php',
			'http://sub6.localhost/php/hsts_cookie.php',
			'http://sub7.localhost/php/hsts_cookie.php',
			'http://sub8.localhost/php/hsts_cookie.php'
		],
		silverlight: toggleValueFromUrl('sl'),
		publisher: function(item, value) {
			//console.log('item = ' + item + '; value = ' + value);
			if (document.getElementById(item)
					&& document.getElementById(item + 'Value')
					&& document.getElementById(item + 'State')) {
				let currentHeadState = document.getElementById(item + 'State').value;
				let newHeadState = currentHeadState;
				if (currentHeadState !== 'hidden') {
					if (value) {
						newHeadState = 'alive';
					} else {
						newHeadState = 'dead';
					}
					if (newHeadState !== currentHeadState) {
						document.getElementById(item).className = 'hydra-head-' + newHeadState;
						document.getElementById(item + 'State').value = newHeadState;
					}
				}
				let currentValue = document.getElementById(item + 'Value').innerHTML;
				if (value !== currentValue) {
					document.getElementById(item + 'Value').innerHTML = value ? value : '???';
				}
			}
		}
	});

	// Refreshing Zombie Cookie head state
	function refreshZombieCookieState(dont_reset) {
		zombieCookie.get(zombieCookieName, function(best, all) {
			document.getElementById("idtag").innerHTML = best ? best  : 'not set';
		}, dont_reset);
	}

	// Generating Zombie Cookie with input value
	function generateZombieCookie() {
		clearInterval(refreshInterval);
		// Wait for previous refresh to finish before regeneration
		// (it could take 300ms)
		setTimeout(function() { zombieCookie.set(zombieCookieName, document.getElementById('uid').value) }, 300);
		autorefreshZombieCookie();
	}

	// Regenerating Zombie Cookie (all heads raising from the death)
	function regenerateZombieCookie() {
		clearInterval(refreshInterval);
		// Wait for previous refresh to finish before regeneration
		// (it could take 300ms)
		setTimeout(function() {
			// Glow effect on alive heads !
			[].forEach.call(document.getElementsByClassName('hydra-head-alive'), function(el) {
				el.classList.remove('glow');
				// Triggering reflow ...
				void el.offsetWidth;
				el.classList.add('glow');
			});
			refreshZombieCookieState(0); // '0' means regeneration of all the dead heads !
		}, 300);
		autorefreshZombieCookie();
	}

	// Refreshing heads every 300 milli seconds
	function autorefreshZombieCookie() {
		refreshInterval = setInterval(refreshZombieCookieState, 300, 1); // '1' means NO regeneration of the dead heads !
	}

	// First operation (depending on input mode)
	if (urlParams.get('mode') === 'regenerate') {
		regenerateZombieCookie();
	} else {
		// "Refresh" mode by default
		autorefreshZombieCookie();
	}
</script>

</body>
</html>
